# 交通流模拟运算与底层机制

本文针对系统内部所使用的核心交通流模型与物理参数影响机制进行详细说明，解释车辆运行、环境干预、异常状况及底层控制链路如何在数学与代码层面调节交通流状态。

---

## 1. 交通流核心模拟机制

系统的主循环仿真依托于**微观交通流模型**，即由车辆个体行为的累加反映宏观交通流的变化。核心主要分为纵向控制（跟驰）与横向控制（换道）。

### 1.1 纵向跟驰控制

系统默认采用 **IDM (Intelligent Driver Model)** 模型，同时也支持更精细的 **Wiedemann 99** 模型。

#### IDM 模型 (Intelligent Driver Model)
IDM 模型能够针对前车速度和距离，输出连续平滑的加速度。其主要数学公式如下：

- **加速度微分公式**：
  $$ a = a_{max} \left[ 1 - \left(\frac{v}{v_0}\right)^\delta - \left(\frac{s^*}{s}\right)^2 \right] $$
- **期望车距公式**：
  $$ s^* = s_0 + v \cdot T + \frac{v \cdot \Delta v}{2\sqrt{a_{max} \cdot b_{desired}}} $$

**公式参数及系统影响**：
- **$v$**：当前车速。
- **$v_0$**：期望速度（无干扰时的最高限速）。
- **$\Delta v$**：自车与前车速度差 ($v - v_{leader}$)。接近前车时，该值为正，会导致 $s^*$ 增加，从而触发减速。
- **$s$**：与前车的实际净距。
- **$s_0$**：最小静止安全间距。
- **$T$**：安全时距（驾驶员的预期安全跟车时间）。
- **$a_{max}$**：最大加速度。
- **$b_{desired}$**：舒适减速度（驾驶员倾向的温和刹车力度）。
- **$\delta$**：加速度衰减指数（通常为 4.0）。

#### Wiedemann 99 模型 (补充物理模型)
针对更复杂的行为，Wiedemann 99 模型将驾驶行为分为四种状态，系统也据此提供了基于物理阈值的仿真选项：
1. **自由行驶**：当与前车距离远大于安全跟车阈值时，向 $v_0$ 自由加速。
2. **趋近**：逐渐接近前车时的缓慢减速状态。
3. **跟车**：进入前车影响范围，不断根据相对速度 $(\Delta v)$ 进行微小加速度振荡 $(-cc7 \sim cc7)$ 以维持跟随。
4. **急停**：与前车距离小于碰撞防护阈值 ($sdx$) 时的强力制动。

### 1.2 横向换道控制 (MOBIL)

变道决策采用 **MOBIL (Minimizing Overall Braking Induced by Lane changes)** 模型，核心思想是在保证安全的前提下，最大化局部车流的整体加速度收益。

- **换道收益评判公式**：
  $$ Gain = (a_{new} - a_{current}) - p \cdot (a_{follower\_new} - a_{follower\_current}) - \text{换道惩罚} $$

**公式参数及系统影响**：
- **$a_{new}$**：换道后（在新车道）自车根据 IDM 算出的加速度。
- **$a_{current}$**：不换道时在当前车道的加速度。
- **$p$** (Politeness, 礼貌系数)：$0 \sim 1$ 之间。$p$ 越低，越不顾及后车；$p$ 越高，越会在意换道对新车道后车造成的减速影响。
- **$a_{follower\_new}$ 与 $a_{follower\_current}$**：评估目标车道后车因自车切入所造成的加速度变化（通常是减速度）。只有整体收益 ($Gain > \text{阈值}$) 时，系统才会允许换道。

---

## 2. 车辆参数与驾驶风格对流态的影响

系统中引入了不同的车辆类型与性格设定，初始化时依据特定权重分布赋予每台车不同的物理属性，以此构筑多元化的复杂车流。

### 2.1 车辆类型参数分布

| 车辆类型 | 占比权重 | 长度 (m) | 期望速度 $v_0$ | 最大加速 $a_{max}$ | 安全时距 $T$ (s) | 质量因子 | 对交通流的影响 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **轿车 (Car)** | 60% | 4.5 | ~120 km/h | 3.0 m/s² | 1.5 | 1.0 | 车流中的主力，灵活穿插，容易引发急刹震荡。 |
| **卡车 (Truck)** | 25% | 12.0 | ~100 km/h | 2.0 m/s² | 1.8 | 2.5 | 启动慢、刹车距离长。重载属性在坡道易压车。 |
| **客车 (Bus)** | 15% | 10.0 | ~90 km/h | 1.8 m/s² | 1.6 | 2.2 | 巡航平稳但限速低，阻挡轿车诱发其变道。 |

### 2.2 驾驶风格参数分布

| 风格 | 占比 | 礼貌系数 $p$ | 最大加速度比 | 反应时间倍率 | 行为表现与影响 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **普通型** | 60% | $0.4 \sim 0.6$ | $0.95 \sim 1.05$ | $1.0 \sim 1.2$ | 中规中矩，构成平稳通行的主体基调。 |
| **激进型** | 20% | $0.1 \sim 0.3$ | $1.10 \sim 1.30$ | $0.8 \sim 1.0$ | 加速猛烈，频切线变道，易引发后车急刹及震荡。 |
| **保守型** | 20% | $0.6 \sim 0.8$ | $0.80 \sim 0.95$ | $1.2 \sim 1.5$ | 行动迟缓，礼让度高，反应慢，容易成为“移动路障”。 |

---

## 3. 环境影响与增强物理机制

### 3.1 天气系统

通过天气乘数系统实时干预所有车辆的期望值：

| 天气类型 | 期望速度因子 | 间隔 $T$ 因子 | 可视距离因子 | 最大加速因子 |
| :--- | :--- | :--- | :--- | :--- |
| **晴天 (Clear)** | 1.0 | 1.0 | 1.0 | 1.0 |
| **雨天 (Rain)** | 0.8 | 1.4 | 0.7 | 0.9 |
| **雪天 (Snow)** | 0.6 | 1.8 | 0.5 | 0.7 |
| **雾天 (Fog)** | 0.7 | 1.6 | 0.3 | 0.85 |
| **大雨 (Heavy)**| 0.65| 1.7 | 0.4 | 0.75 |

恶劣天气会显著拉长车距（$T$ 的增加）和降低制动能力，导致整体车流密度下降，通行效率锐减。

### 3.2 道路几何与坡度

- **坡度影响**：处于上坡时，加速度受重力削减。质量越大的车（如卡车），衰减越严重。
- **视距受限与弯道**：进入弯道或受浓雾影响时有效视距缩短。如果前车不在可视范围，无法提前制动。
- **长下坡限速**：重型车辆在长下坡（>3%）时，受到强制安全限速防止失控。

### 3.3 反应延迟与高速动力衰减

- **反应延迟 (Reaction Time Delay)**：系统维护感知队列，驾驶员决策存在延迟。延迟越高，次生震荡概率越大。
- **高速动力衰减**：模拟空气阻力限制，车速比 $> 0.7$ 时引擎剩余加速大幅衰减。

---

## 4. 异常机制及交通流冲击的传播

### 4.1 异常引发机制
系统按概率对部分车辆强制干预：
- **完全停止**：目标速度直降为 0，触发最强减速（$-7.0 m/s^2$）。
- **短/长时限速**：目标速度骤降持续 10/20 秒，模拟避让异物等场景。

### 4.2 异常事件的影响传播

1. **分阶段紧急制动**：超远距轻微减速 $\rightarrow$ 逼近极限急刹。
2. **强制避让**：后方靠近时旁路 MOBIL 收益，触发强制变道。导致相邻车道迅速过载并出现波浪。
3. **多异常源叠加打击**：下游异常产生恐慌乘数（$0.85^n$），上游异常产生（$0.95^n$）。导致轻微减速在几公里外形成莫名拥堵停滞（幽灵堵车）。

---

## 5. 仿真平台底层机制 (Engine Mechanisms)

### 5.1 自适应仿真进度控制 (Adaptive Progress Control)
- **问题**：固定终止时间（如 300s）下，后方拥堵车辆若未离场会导致统计不完整。
- **机制**：通过 **末态监控器 (Last Vehicle Monitor)** 实时检测最后一辆车位置及瞬时速度。若预计无法准时到达，引擎动态增加“缓冲区时间”，UI 进度条随之动态增长。

### 5.2 异构路网动态边界检测 (Heterogeneous Boundary Detection)
- **挑战**：不均匀路段（例如 2km, 200m, 1km 混合）下固定步长机制失效。
- **机制**：引入 **状态感知边界追踪 (State-Aware Boundary Tracking)**。边界投影至每辆车。当大跨度时间帧跨越多个短区间时，通过内联 `while` 依序结算各区间的进入时间和瞬时速度，给出精准区间时钟。

### 5.3 微观分析：动态色彩映射 (Dynamic Visual Mapping)
- **背景**：高速公路上 100km/h 和 110km/h 颜色在绝对量程下难以区分。
- **机制**：微观分析组件拉伸色彩区间，采用此视图内的 $[V_{min}, V_{max}]$ 作为梯度映射，帮助发现局部轻微干扰。

### 5.4 高效数据流架构 (High-Performance Data Flow)
采用 **前后台异构采样策略**：
- **前端内存 (High-Fidelity)**：每 0.1s 采样（10w+ 点），用于实时交互、散点图无缝缩放。
- **后端上传 (Optimized-Payload)**：每 1.0s 采样（1w 点），用于持久化存储静态图表和降低传输压力。
