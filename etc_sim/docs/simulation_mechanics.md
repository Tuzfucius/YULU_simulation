# 交通流模拟运算与机制

本书针对系统内部所使用的核心交通流模型与物理参数影响机制进行详细说明，解释车辆运行、环境干预及异常状况如何在数学与代码层面调节交通流状态。

---

## 1. 交通流核心模拟机制

系统的主循环仿真依托于**微观交通流模型**，即由车辆个体行为的累加反映宏观交通流的变化。核心主要分为纵向控制（跟驰）与横向控制（换道）。

### 1.1 纵向跟驰控制

系统默认采用 **IDM (Intelligent Driver Model)** 模型，同时也支持更精细的 **Wiedemann 99** 模型。

#### IDM 模型 (Intelligent Driver Model)
IDM 模型能够针对前车速度和距离，输出连续平滑的加速度。其主要数学公式如下：

- **加速度微分公式**：
  $$ a = a_{max} \left[ 1 - \left(\frac{v}{v_0}\right)^\delta - \left(\frac{s^*}{s}\right)^2 \right] $$
- **期望车距公式**：
  $$ s^* = s_0 + v \cdot T + \frac{v \cdot \Delta v}{2\sqrt{a_{max} \cdot b_{desired}}} $$

**公式参数及系统影响**：
- **$v$**：当前车速。
- **$v_0$**：期望速度（无干扰时的最高限速）。
- **$\Delta v$**：自车与前车速度差 ($v - v_{leader}$)。接近前车时，该值为正，会导致 $s^*$ 增加，从而触发减速。
- **$s$**：与前车的实际净距。
- **$s_0$**：最小静止安全间距。
- **$T$**：安全时距（驾驶员的预期安全跟车时间）。
- **$a_{max}$**：最大加速度。
- **$b_{desired}$**：舒适减速度（驾驶员倾向的温和刹车力度）。
- **$\delta$**：加速度衰减指数（通常为 4.0）。

#### Wiedemann 99 模型 (补充物理模型)
针对更复杂的行为，Wiedemann 99 模型将驾驶行为分为四种状态，系统也据此提供了基于物理阈值的仿真选项：
1. **自由行驶**：当与前车距离远大于安全跟车阈值时，向 $v_0$ 自由加速。
2. **趋近**：逐渐接近前车时的缓慢减速状态。
3. **跟车**：进入前车影响范围，不断根据相对速度 $(\Delta v)$ 进行微小加速度振荡 $(-cc7 \sim cc7)$ 以维持跟随。
4. **急停**：与前车距离小于碰撞防护阈值 ($sdx$) 时的强力制动。

### 1.2 横向换道控制 (MOBIL)

变道决策采用 **MOBIL (Minimizing Overall Braking Induced by Lane changes)** 模型，核心思想是在保证安全的前提下，最大化局部车流的整体加速度收益。

- **换道收益评判公式**：
  $$ Gain = (a_{new} - a_{current}) - p \cdot (a_{follower\_new} - a_{follower\_current}) - \text{换道惩罚} $$

**公式参数及系统影响**：
- **$a_{new}$**：换道后（在新车道）自车根据 IDM 算出的加速度。
- **$a_{current}$**：不换道时在当前车道的加速度。
- **$p$** (Politeness, 礼貌系数)：$0 \sim 1$ 之间。$p$ 越低，越不顾及后车；$p$ 越高，越会在意换道对新车道后车造成的减速影响。
- **$a_{follower\_new}$ 与 $a_{follower\_current}$**：评估目标车道后车因自车切入所造成的加速度变化（通常是减速度）。只有整体收益 ($Gain > \text{阈值}$) 时，系统才会允许换道。

---

## 2. 车辆参数与驾驶风格对流态的影响

系统中引入了不同的车辆类型与性格设定，初始化时依据特定权重分布赋予每台车不同的物理属性，以此构筑多元化的复杂车流。

### 2.1 车辆类型参数分布

不同车型具有不同的物理限制，重型车（客车与卡车）表现为加减速迟缓，进而容易在车流中形成局部瓶颈（移动瓶颈）。

| 车辆类型 | 占比权重 | 长度 (m) | 期望速度 $v_0$ (km/h) | 最大加速 $a_{max}$ | 安全时距 $T$ (s) | 质量因子 | 对交通流的影响 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **轿车 (Car)** | 60% | 4.5 | ~120 | 3.0 m/s² | 1.5 | 1.0 | 车流中的主力，灵活穿插，容易引发急刹震荡。 |
| **卡车 (Truck)** | 25% | 12.0 | ~100 | 2.0 m/s² | 1.8 | 2.5 | 启动慢、刹车距离长、占据空间大。其重载属性在坡道上极易压车。 |
| **客车 (Bus)** | 15% | 10.0 | ~90 | 1.8 m/s² | 1.6 | 2.2 | 巡航平稳但限速低，会显著阻挡后方轿车，诱发其频繁换道。 |

### 2.2 驾驶风格参数分布

车辆被赋予特定的性格，影响其激进程度和礼让系数（MOBIL 模型中的 $p$ 参数）及反应时间。

| 风格 | 占比 | 礼貌系数 $p$ | 最大加速度比 | 反应时间倍率 | 行为表现与影响 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **普通型** | 60% | $0.4 \sim 0.6$ | $0.95 \sim 1.05$ | $1.0 \sim 1.2$ | 中规中矩，构成平稳通行的主体基调。 |
| **激进型** | 20% | $0.1 \sim 0.3$ | $1.10 \sim 1.30$ | $0.8 \sim 1.0$ | 加速猛烈，极少顾及后车感受（高频切线变道），极易引发后车急刹进而形成走走停停（Stop-and-Go）的波澜。 |
| **保守型** | 20% | $0.6 \sim 0.8$ | $0.80 \sim 0.95$ | $1.2 \sim 1.5$ | 行动迟缓，礼让度高，反应慢，容易成为车流中“移动的路障”，降低车道通行效率。 |

---

## 3. 环境影响与增强物理机制

环境模块通过全局乘子实时影响行驶参数。其不仅改变个体的加速度，从而在宏观上体现为道路通行能力（Capacity）的下降。

### 3.1 天气系统

通过天气乘数系统实时干预所有车辆的期望值：

| 天气类型 | 期望速度因子 | 间隔 $T$ 因子 | 可视距离因子 | 最大加速因子 |
| :--- | :--- | :--- | :--- | :--- |
| **晴天 (Clear)** | 1.0 | 1.0 | 1.0 | 1.0 |
| **雨天 (Rain)** | 0.8 | 1.4 | 0.7 | 0.9 |
| **雪天 (Snow)** | 0.6 | 1.8 | 0.5 | 0.7 |
| **雾天 (Fog)** | 0.7 | 1.6 | 0.3 | 0.85 |
| **大雨 (Heavy Rain)** | 0.65| 1.7 | 0.4 | 0.75 |

**说明**：恶劣天气会显著拉长车距（$T$ 的增加）和降低制动能力，导致整体车流密度迅速下降，通行效率锐减。

### 3.2 道路几何与坡度

- **坡度影响加速度**：
  $$ a_{adjust} = -g \cdot \sin(\theta) \cdot mass\_factor $$
  *当车辆处于上坡时，加速度收到重力分量削减。质量因子越大的车辆（如卡车 $mass\_factor=2.5$），衰减越严重。*
- **视距受限与弯道**：
  $$ vis_{effective} = \min \left(vis_{weather},\ \sqrt{2 \cdot Radius_{curve} \cdot 1.2}\right) $$
  *进入弯道或受浓雾影响时，有效视距 $vis$ 缩短。如果前车不在可视范围内，即使距离近，自车也无法做出提前制动。*
- **长下坡限速**：
  重型车辆（Truck, Bus）在长下坡（>3% 或 >5%）时，受到强制安全限速（例如 60% 限速），防止失控，这会在下坡段形成车流堆积点。

### 3.3 反应延迟与高速动力衰减

- **反应延迟 (Reaction Time Delay)**：
  系统在内部维护了一个感知队列 `PerceptionState`。驾驶员决策用的 $(v_{leader}, s)$ 实际上是当前时间减去 `reaction_time` 的历史状态数据。延迟越高（防碰撞反应慢），发生追尾与交通流次生震荡的概率越大。
- **高速动力衰减**：
  模拟空气阻力限制。当车速比 $v / v_0 > 0.7$ 时，引擎的剩余出力加速大幅度线性衰减。防止车辆无限保持完美的启动加速度。

---

## 4. 异常机制及交通流冲击的传播

模拟的重要目的是观测少数“非预期状况”是如何涟漪般传播并导致全局崩溃的。系统的异常车辆模块为此引入了特定的触发器及传播机制。

### 4.1 异常的种类

系统在全局仿真时间足够后，按 `anomaly_ratio` 概率对部分车辆进行强制干预：
- **异常类型 1（完全停止）**：目标速度直降为 0（重度事故或死火），强制启动最强减速（$max\_decel=7.0$）。
- **异常类型 2（短时限速）**：目标速度骤降（如限制到 $0 \sim 40$ km/h），持续 10 秒（如避让异物、严重操作失误）。
- **异常类型 3（长时限速）**：同类型 2，但持续 20 秒（较长时间的占用车道）。

### 4.2 异常事件的影响传播机制

由于跟驰与换道模型的存在，一辆异常车将立刻对其周围产生物理辐射：

1. **分阶段紧急制动 (由距离 $s$ 决定)**：
   对于前方遭遇静止异常车辆时，IDM 的常规缓刹会被系统重写并接管：
   - $> 200m$：远距轻微减速。
   - $100 \sim 200m$：线性增加到 $-4.0 m/s^2$。
   - $30 \sim 100m$：增强制动，逼近极限（$-7.0 m/s^2$）。
   - $< 30m$：强制防碰撞系统急刹触发。
2. **强制避让与横向溢出**：
   当后方车辆靠近异常车小于警戒距离时，MOBIL 里的“收益评估”被旁路，触发 `forced`（强制）换道机制。大批车辆集体涌入相邻车道，会导致平行车道迅速过载并出现“强行加塞引起的刹车波浪”。
3. **多异常源叠加打击 (Impact Multiplier)**：
   本系统设计了多故障车环境下的乘子效应。系统计算周边一定距离 ($200m$) 的异常车辆数量 $n$：
   - 下游异常车带来 $0.85^n$ 的减速压迫乘数。
   - 上游异常车带来 $0.95^n$ 的恐慌减速乘数。
   
   上述现象直接解释了：哪怕是一次简单的减速（如类型 2），也会因为后车延迟反应、$T$（安全时距）造成的放大效应，而在上游几公里外形成莫名其妙的拥堵停滞（幽灵堵车 Phantom Traffic Jam）。
