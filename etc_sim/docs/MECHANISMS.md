# ETC 仿真系统核心机制深入解读

本文旨在为研究人员和开发者提供 ETC 交通仿真系统底层机制的深度解析，涵盖自适应控制、精准统计与高性能可视化等核心模块。

---

## 1. 自适应仿真进度控制 (Adaptive Progress Control)

### 1.1 问题背景
传统的交通仿真通常设定固定的终止时间（如 300s）。但在研究“异常事件”时，由于拥堵会导致后方车辆通行速度极慢，若在 300s 准时停止，末位车辆可能仍在路段内，导致结果统计不完整。

### 1.2 实现机制
仿真引擎通过 **末态监控器 (Last Vehicle Monitor)** 动态调整时钟。
- **实时预估**：引擎每帧检测路网中最后一辆车的位置及瞬时速度。
- **动态延展**：若最后一辆车预计无法在当前总时间内到达终点，引擎会根据其速度动态增加“缓冲区时间”。
- **UI 联动**：进度条的分母会随之动态增长，确保用户能实时看到“为了等待车辆离场所进行的额外仿真”。

---

## 2. 异构路网动态边界检测 (Heterogeneous Boundary Detection)

### 2.1 挑战
当路网存在不均匀划分（例如第一段 2km，第二段 200m，第三段 1km）时，基于固定步长或简单的 `pos % length` 逻辑会失效。

### 2.2 核心算法
车辆类（`Vehicle.ts`）引入了 **状态感知边界追踪 (State-Aware Boundary Tracking)**：
- **边界投影**：引擎将路网配置的所有断面位置（Meters）投影给每一辆车。
- **跨段补偿**：当车辆在极大的加速度下或极高的离散步长中单帧跨越多个短区间时，算法会通过内联 `while` 循环依序结算各个区间的进入、离开时间和瞬时速度。
- **精准均值**：通过计算车辆在特定区间内的停留总时长（而不是简单的采样平均），得出更符合物理事实的区间平均速度。

---

## 3. 微观分析：动态色彩映射机制 (Dynamic Visual Mapping)

### 3.1 视觉心理学应用
在 120km/h 的高速公路上，一辆 100km/h 的车和一辆 110km/h 的车在传统固定量程（0-120）下颜色几乎无异。用户很难察觉“由于微波波动导致的轻微减速”。

### 3.2 动态量程缩放 (Auto-Scaling Range)
微观分析组件（`MicroscopicInspector`）采用了 **视图相关量程分配**：
- **统计聚合**：实时计算当前视图（或选定区间）内所有车辆样本的 $V_{min}$ 和 $V_{max}$。
- **色彩拉伸**：将 ECharts 的 VisualMap 颜色梯度完整地映射在 $[V_{min}, V_{max}]$ 区间内。
- **效果**：即使在全线畅通的情况下，通过拉伸色彩范围，用户也能一眼识别出哪些车辆处于相对低速状态，有助于发现潜在的驾驶风格差异或轻微干扰。

---

## 4. 高效数据流架构 (High-Performance Data Flow)

系统采用了 **前后台异构采样策略 (Asymmetric Sampling Strategy)**：

| 维度 | 前端内存 (High-Fidelity) | 后端上传 (Optimized-Payload) |
|------|------------------------|----------------------------|
| **目的** | 实时交互、秒级细节预览 | 生成永久存档图表、Matplotlib 绘图 |
| **采样率** | 每 0.1s 采样一次 (100%) | 每 1.0s 采样一次 (10%) |
| **数据规模** | ~100,000 点 | ~10,000 点 |
| **优势** | 保证 DataZoom 放大后的丝滑感 | 解决请求超时报错，优化后端处理压力 |

---

*如需进一步了解仿真算法（IDM/MOBIL），请参阅 [README.md](../README.md#仿真算法)。*
